name: Keep Neo4j Aura Alive

on:
  schedule:
    - cron: '0 12 * * *'  # Runs daily at 12pm UTC
  workflow_dispatch:  # Allows manual trigger

jobs:
  ping-neo4j:
    runs-on: ubuntu-latest
    steps:
      - name: Set up Python
        uses: actions/setup-python@v5
        with:
          python-version: '3.11'
      
      - name: Install Neo4j driver
        run: pip install neo4j==6.0.2
      
      - name: Query Neo4j
        env:
          NEO4J_URI: ${{ secrets.NEO4J_URI }}
          NEO4J_USERNAME: ${{ secrets.NEO4J_USERNAME }}
          NEO4J_PASSWORD: ${{ secrets.NEO4J_PASSWORD }}
        run: |
          python << EOF
          from neo4j import GraphDatabase
          import os
          import sys
          
          # Validate environment variables
          required_vars = ['NEO4J_URI', 'NEO4J_USERNAME', 'NEO4J_PASSWORD']
          missing = [var for var in required_vars if not os.environ.get(var)]
          if missing:
              print(f"Error: Missing required environment variables: {', '.join(missing)}")
              sys.exit(1)
          
          uri = os.environ['NEO4J_URI']
          username = os.environ['NEO4J_USERNAME']
          password = os.environ['NEO4J_PASSWORD']
          
          try:
              driver = GraphDatabase.driver(
                  uri,
                  auth=(username, password),
                  connection_timeout=10  # 10 second timeout
              )
              
              # Use driver as context manager for proper cleanup
              with driver:
                  with driver.session() as session:
                      result = session.run("RETURN 1 as alive")
                      record = result.single()
                      if record:
                          print(f"✓ Neo4j is alive: {record['alive']}")
                      else:
                          print("Error: No result returned from Neo4j")
                          sys.exit(1)
          except Exception as e:
              print(f"✗ Error connecting to Neo4j: {str(e)}")
              sys.exit(1)
          EOF